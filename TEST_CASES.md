# NoviceTrack 附件选择器 Bug 修复 - 测试用例

## 测试目标
验证附件选择器在前端交互中的三个核心问题是否已修复：
1. 双击没反应（事件绑定丢失）
2. 模态框不显示图片（渲染时序问题）
3. 新对话后问题重现（状态重置问题）

## 测试环境
- 浏览器：Chrome/Firefox/Edge 最新版
- 服务器：Flask 运行在 http://localhost:5010
- 测试文件：确保 `assets/candidates/` 目录中有至少 5 个图片文件

---

## 测试用例组 A：基础功能测试

### 测试用例 A1：首次打开选择器 - 应显示所有图片 ✓
**前置条件：**
- 启动 Flask 服务器
- 打开浏览器访问 http://localhost:5010
- 等待页面完全加载（选项卡停止转圈）

**测试步骤：**
1. 点击右下角的 📎 附件按钮
2. 观察模态框弹出动画
3. 等待网格加载完成（最多 2 秒）

**预期结果（修复后）：**
- ✅ 模态框在 0.5 秒内显示
- ✅ 网格中显示所有 assets/candidates 中的图片缩略图
- ✅ 每个缩略图下方显示文件名和大小
- ✅ 缩略图显示正常（无破损图标）

**预期结果（修复前 - 失败）：**
- ❌ 模态框立即显示但网格空白
- ❌ 或长时间转圈不显示内容
- ❌ 或显示"file-icon"占位符而非图片

---

### 测试用例 A2：双击选择图片 - 应添加到附件列表 ✓
**前置条件：**
- 已完成测试 A1，模态框正常显示

**测试步骤：**
1. 找到任意图片卡片（例如 "BYD.jpg"）
2. 快速双击该卡片（注意：不是单击）
3. 观察：
   - 模态框是否关闭
   - 底部附件列表（#chip）是否出现该文件
   - Toast 提示是否显示

**预期结果（修复后）：**
- ✅ 模态框立即关闭（没有延迟）
- ✅ 底部附件列表中显示所选文件的缩略图、名称、大小
- ✅ Toast 显示"已加入待发送"或"已加入待发送列表"
- ✅ 再次打开选择器时，该文件卡片有"已选择"标记

**预期结果（修复前 - 失败）：**
- ❌ 双击后无反应（模态框不关闭）
- ❌ 底部附件列表不显示该文件
- ❌ 没有任何反馈提示

---

## 测试用例组 B：重复打开测试

### 测试用例 B1：第二次打开选择器 - 应保持正常 ✓
**前置条件：**
- 已完成测试 A2，已选择至少 1 个文件

**测试步骤：**
1. 再次点击 📎 按钮打开选择器
2. 观察加载速度
3. 等待网格显示
4. 尝试单击（不双击）已选择的文件卡片

**预期结果（修复后）：**
- ✅ 模态框几乎瞬时显示（因为已初始化）
- ✅ 网格内容与首次打开一致
- ✅ 已选择的文件卡片有视觉标记（灰色或角标）
- ✅ 仍可双击其他图片进行选择

**预期结果（修复前 - 失败）：**
- ❌ 再次打开时网格空白
- ❌ 已选择的文件标记消失
- ❌ 双击新文件无反应

---

### 测试用例 B2：快速连续打开关闭 - 应无闪烁 ✓
**前置条件：**
- 页面正常工作

**测试步骤：**
1. 点击 📎 打开选择器
2. 立即点击"关闭"按钮
3. 立即再点击 📎 打开
4. 重复 3 次以上

**预期结果（修复后）：**
- ✅ 每次操作都有平滑的显示/隐藏动画
- ✅ 网格内容保持稳定（不闪烁、不重置）
- ✅ 无控制台错误

**预期结果（修复前 - 失败）：**
- ❌ 网格内容闪烁或重置
- ❌ 出现空白网格
- ❌ 双击事件有时生效有时不生效

---

## 测试用例组 C：新对话场景测试 ⚠️

### 测试用例 C1：选择文件后开启新对话 - 应清空并重置 ✓
**前置条件：**
- 已完成测试 A2，当前有 1-2 个待发送附件

**测试步骤：**
1. 观察底部附件列表，确认有待发送文件
2. 点击左侧边栏的"新对话"按钮
3. 观察：
   - 附件列表是否清空
   - 对话区是否清空
   - Toast 是否提示"已开始新对话"
4. 再次点击 📎 打开选择器

**预期结果（修复后）：**
- ✅ 附件列表立即清空
- ✅ 对话区重置到初始状态（显示 Hero 文案）
- ✅ 打开选择器时网格正常显示
- ✅ 双击选择功能正常

**预期结果（修复前 - 失败）：**
- ❌ 新对话后打开选择器显示空白
- ❌ 双击新选择的图片无反应
- ❌ 需要刷新页面才能恢复

---

### 测试用例 C2：新对话后快速选择图片 ✓
**前置条件：**
- 已完成测试 C1，已开启新对话

**测试步骤：**
1. 开启新对话题后立即点击 📎
2. 快速双击任意图片
3. 观察选择是否成功

**预期结果（修复后）：**
- ✅ 图片正常添加到附件列表
- ✅ 无任何错误提示

**预期结果（修复前 - 失败）：**
- ❌ 选择器显示空白网格
- ❌ 双击无反应
- ❌ 需要先刷新并取消，再操作才正常

---

## 测试用例组 D：多文件及切换模式测试

### 测试用例 D1：选择多个文件 - 应全部添加 ✓
**前置条件：**
- 选择器正常显示

**测试步骤：**
1. 双击第 1 个图片
2. 再次打开选择器
3. 双击第 3 个图片
4. 再次打开选择器
5. 双击第 5 个图片
6. 观察底部附件列表

**预期结果（修复后）：**
- ✅ 底部显示 3 个附件的缩略图和名称
- ✅ 每个附件右侧有 ❌ 删除按钮
- ✅ 文件按选择顺序排列

**预期结果（修复前 - 失败）：**
- ❌ 重复添加同一文件
- ❌ 第二次或第三次选择无响应
- ❌ 已选择的文件未在模态框中标记

---

### 测试用例 D2：切换任务模式后打开选择器 ✓
**前置条件：**
- 已选择 2 个文件

**测试步骤：**
1. 点击顶部下拉框（GPT 5）
2. 切换到"GPT 5 • 任务I"
3. 观察是否自动切换到新对话（trial_id 变化）
4. 点击 📎 打开选择器
5. 尝试选择新图片

**预期结果（修复后）：**
- ✅ 切换模式后自动开始新对话（Toast 提示）
- ✅ 原附件列表清空
- ✅ 选择器正常显示所有图片
- ✅ 新选择的文件正常添加到列表

**预期结果（修复前 - 失败）：**
- ❌ 选择器显示空白
- ❌ 选择图片后附件列表为空或错乱

---

## 测试用例组 E：极端场景测试

### 测试用例 E1：快速双击多个文件 ✓
**前置条件：**
- 选择器正常显示

**测试步骤：**
1. 打开选择器
2. 在 2 秒内快速连续双击 3 个不同的图片
3. 观察结果

**预期结果（修复后）：**
- ✅ 所有 3 个文件都添加到附件列表
- ✅ 每次选择都有 Toast 提示
- ✅ 无控制台错误

**预期结果（修复前 - 失败）：**
- ❌ 只有第 1 个文件被添加
- ❌ 后续双击无反应
- ❌ 出现 JS 错误

---

### 测试用例 E2：打开选择器后取消 - 应无副作用 ✓
**前置条件：**
- 无

**测试步骤：**
1. 点击 📎 打开选择器
2. 等待网格完全加载
3. 点击"关闭"按钮或点击模态框背景
4. 不选择任何文件
5. 重复 5 次

**预期结果（修复后）：**
- ✅ 每次都能正常打开和关闭
- ✅ 网格内容保持不变
- ✅ 无内存泄漏或重复绑定事件
- ✅ 控制台无错误

**预期结果（修复前 - 失败）：**
- ❌ 多次操作后事件失效
- ❌ 网格显示异常

---

## 测试用例组 F：页面加载时序测试

### 测试用例 F1：页面加载完成后立即打开选择器 ✓
**前置条件：**
- 打开新标签页
- 输入 http://localhost:5010 并回车

**测试步骤：**
1. 等待页面完全加载（Logo 显示、Hero 文案显示）
2. **立即**点击 📎 按钮
3. 不要等待，立即观察模态框

**预期结果（修复后）：**
- ✅ 模态框快速显示
- ✅ 网格在 1-2 秒内正常加载所有图片
- ✅ 双击功能正常

**预期结果（修复前 - 失败）：**
- ❌ 页面选项卡持续转圈
- ❌ 点击按钮后模态框长时间空白
- ❌ 需要点击"×"或刷新页面才能恢复

---

## 已知问题严重程度对比

| 测试用例 | 修复前问题描述 | 严重程度 | 预计修复率 |
|---------|--------------|---------|-----------|
| A1 | 图片不显示/空白网格 | **严重** | 95% |
| A2 | 双击无反应 | **严重** | 90% |
| B1 | 重复打开失败 | **严重** | 95% |
| C1 | 新对话后问题重现 | **非常严重** | 100% |
| C2 | 切换模式后不可用 | **非常严重** | 100% |
| E1 | 快速操作失败 | 中等 | 85% |
| F1 | 页面加载时序问题 | **严重** | 90% |

---

## 测试自动化建议

由于这些测试主要是 UI 交互测试，建议使用以下工具进行自动化：

1. **Playwright** (推荐)
```bash
npm install -D @playwright/test
npx playwright test
```

2. **Selenium** (备选)
```python
pip install selenium
# 需要下载对应浏览器驱动
```

3. **Cypress** (备选)
```bash
npm install cypress --save-dev
npx cypress open
```

---

## 快速验证脚本（手动）

如果无法运行自动化测试，可以通过浏览器控制台快速验证：

```javascript
// 在浏览器控制台执行以下代码：

// 1. 验证选择器是否正确初始化
console.log('PICKER_INITIALIZED:', typeof PICKER_INITIALIZED !== 'undefined');

// 2. 统计网格中的图片数量
const grid = document.querySelector('#picker-grid');
const cells = grid.querySelectorAll('.cell');
console.log('网格单元格数量:', cells.length);

// 3. 检查双击事件是否绑定
cells.forEach((cell, i) => {
  const hasHandler = !!cell.ondblclick;
  console.log(`单元格 ${i}: ondblclick 事件 ${hasHandler ? '✓ 已绑定' : '❌ 未绑定'}`);
});

// 4. 快速测试：连续 5 次打开/关闭
for (let i = 0; i < 5; i++) {
  console.log(`\n=== 第 ${i+1} 次测试 ===`);
  console.time('打开选择器');
  window.openPicker();
  setTimeout(() => {
    console.timeEnd('打开选择器');
    const visible = document.querySelector('#mask.show') !== null;
    console.log('模态框显示:', visible);
    console.log('网格单元格数:', document.querySelectorAll('.cell').length);
    setTimeout(() => window.closePicker(), 500);
  }, 1000);
}
```

---

## 测试报告模板

```
=== NoviceTrack 附件选择器测试报告 ===

测试时间：YYYY-MM-DD HH:MM
测试环境：Chrome XX.XX / Firefox XX.XX / Edge XX.XX
Flask 版本：3.0.3
后端 API：正常 / 异常

测试结果：
✓ A1 - 首次打开选择器：通过 / 失败
✓ A2 - 双击选择图片：通过 / 失败
✓ B1 - 重复打开选择器：通过 / 失败
✓ C1 - 新对话后重置：通过 / 失败
✓ C2 - 新对话后快速选择：通过 / 失败
✓ D1 - 多文件选择：通过 / 失败
✓ D2 - 模式切换：通过 / 失败
✓ E1 - 快速双击：通过 / 失败
✓ E2 - 多次取消：通过 / 失败
✓ F1 - 页面加载时序：通过 / 失败

通过率：X/11 (XX%)

控制台错误（如有）：
- 错误1：[描述]
- 错误2：[描述]

改进建议：
1. [建议1]
2. [建议2]

总体评价：
[描述测试感受和改进意见]
```

---

## 结语

这个测试套件覆盖了附件选择器的主要使用场景和已知问题。通过运行这些测试，你可以全面地验证修复效果。

**关键测试项：** 重点测试 C1 和 C2（新对话场景），这是用户反映最频繁的问题。如果这两个测试通过，说明核心问题已解决。

如果某些测试失败，请记录具体失败步骤和控制台错误信息，这将有助于进一步诊断和修复。

祝测试顺利！ 🎉