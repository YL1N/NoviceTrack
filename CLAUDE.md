# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

NoviceTrack is a multimodal AI experiment platform built with Flask that supports image-text conflict arbitration using the Qwen3-VL vision-language model. The system enables research on how AI assistants handle conflicts between user text descriptions and uploaded images.

## Development Environment

### Quick Start

```bash
# Install dependencies
pip install -r requirements.txt

# Run the application
python app.py
```

The server starts at `http://0.0.0.0:5010` (configurable via environment variables).

### Configuration

Key configuration is managed through environment variables (see `config.py`):

- `DASHSCOPE_API_KEY`: API key for DashScope/ModelScope (Qwen model access)
- `MODEL`: Model name (default: "qwen3-vl-plus")
- `HOST`, `PORT`: Server binding (default: 0.0.0.0:5010)
- `DEBUG`: Debug mode (default: 1)
- `ASSETS_DIR`: Asset directory for uploads (default: `assets/candidates/`)
- `LOG_DIR`: Log storage directory (default: `data/logs/`)
- `THUMB_DIR`: Thumbnail generation directory (default: `assets/_thumbs/`)

### Dependencies

Core dependencies (from `requirements.txt`):
- **Flask 3.0.3**: Web framework
- **requests 2.32.3**: HTTP client for API calls
- **Pillow 10.4.0**: Optional image processing
- **python-dotenv 1.0.1**: Optional environment variable management

## Architecture

### Core Flow: Text-Image Arbitration Pipeline

1. **Asset Picker** (`/api/pick`): User selects images/files from ASSETS_DIR
2. **Arbiter Decision** (`arbiter_decide` in app.py):
   - **Image Tagger** (`image_brief`): Calls vision model to classify images by domain (vehicle/smartphone/herb/landscape/fruit/appliance/worksheet/medicine)
   - **Conflict Detector**: Compares user text with image classifications to identify conflicts
3. **Routing**: Based on arbitration results:
   - `NORMAL`: Neutral assist without special conflict handling
   - `CONFLICT`: Text-image conflict detected → enables specialized system prompts
   - `TEXT_ONLY`/`IMAGE_ONLY`: User explicitly confirmed preference
4. **Generation**: Calls Qwen3-VL with appropriate system prompt and selected attachments

### Session Management

- **Session isolation**: Each browser session gets unique `session_id`
- **Trial tracking**: New conversation trials are tracked via `trial_id` (separate from session)
- **Mode switching**: Switching modes (free/task_i/task_ii/task_iii) creates new trial and clears chat history
- **History tracking**: Session history stored in `_GLOBAL_CHAT_HISTORY` (app.py:169-210)

### Data Flow

**User Input** → **Attachment Selection** → **Image Tagging** → **Arbiter** → **Route Selection** → **System Prompt** → **LLM Generation**

### Conflict Detection Logic

The arbiter (app.py:712-848) detects conflicts when:
- **Brand/Model mismatch**: User says "Tesla" but image shows BYD (confidence ≥0.6)
- **Category mismatch**: Text mentions "apples" but image shows oranges
- **Attribute conflict**: Text says "red apple" but image shows green apple
- **Multi-instance ambiguity**: Text uses singular ("this pillbox") but image shows multiple similar objects

### Rate Limiting

- **Global rate limit window**: Sets `_RATE_LIMIT_UNTIL` when 429 errors occur
- **Image tagging skipped**: During rate limit windows, skips image analysis to reduce API calls
- **Exponential backoff**: 3-iteration retry with exponential delay (408-410)

### Task Modes

**Task I** (app.py:1082-1094): "Neighbor deception" - selected image replaced with random neighbor in tree or adjacent index
**Task II/III**: Reserved for future experimental conditions

### Domain-Specific Handling

- **Vehicle/Smartphone**: Normalizes brand/model aliases (e.g., "汉"→"Han")
- **Herbs**: Distinguishes goji/cassia seed
- **Landmarks**: Normalizes mount fuji, west lake
- **Fruits/Appliance/Worksheet/Medicine**: Domain-aware attribute extraction (colors, counts, knobs, panel text, etc.)

### Prompt Strategy

- **Line A (岚/Strategy A)**: Proactive structured helper - provides 2-3 options when conflict detected
- **Line B (松/Strategy B)**: Transparent supporter - identifies ambiguous elements when conflict detected
- **Line C (雾/Strategy C)**: Explanatory natural - describes reasoning when conflict detected
- **Default**: Standard helpful assistant with neutral prompt

### Image Processing

- **Thumbnails**: Auto-generated by Pillow (downscale_to_b64)
- **Inline limit**: 350KB for image attachments
- **Supported formats**: .png, .jpg, .jpeg, .webp, .gif, .bmp
- **Fallback**: Serves original file if thumbnail generation fails

### SSE Streaming

- **Primary mode**: `/api/send_stream` uses SSE for real-time response
- **Fallback mode**: `/api/send` regular endpoint for non-streaming support
- **Watchdog timeout**: 3.5s for first chunk on SSE, auto-falls back to non-streaming if timeout

### Debugging

Set `DEBUG_MODE = 1` in app.py line 39 to enable verbose debug output:
- Upstream API request/response (app.py:1018-1025)
- Arbitration decisions
- Rate limiting status
- Image selection lists

### Important Notes When Modifying

1. **Never remove `trial_id` tracking**: Critical for experiment design (Task I deception)
2. **Keep history management functional**: History is used for multi-turn conversations but not repeated with images
3. **Preserve space handling**: Asset paths must be URL-encoded (`encodeURIComponent`)
4. **Attachment lifecycle**: Picks cleared on context switch (mode change) and new chat
5. **Conflict logic order**: Alias normalization → confidence thresholding → default behavior

## API Endpoints

- `GET /`: UI index page
- `GET /api/picker_list`: List available assets (image thumbnails + metadata)
- `POST /api/pick`: User picks asset (handles Task I deception)
- `POST /api/remove_pick`: Remove selected asset
- `GET /thumb/<path>`: Lazy thumbnail generator
- `POST /api/send_stream`: Primary inference endpoint (SSE)
- `POST /api/send`: Fallback inference endpoint (non-streaming)
- `POST /api/set_line`: Switch between strategies (A/B/C)
- `POST /api/set_mode`: Switch experiment modes (free/I/II/III)
- `POST /api/new_chat`: Reset conversation while keeping session
- `POST /api/log`: Client-side logging endpoint

## Frontend Notes

The frontend (static/app.js) implements:
- **Double-click selection**: Files selected via double-click on grid cell
- **Client-side dedup**: Prevents duplicate attachments in UI
- **Streaming support**: Real-time text generation with SSE
- **Abort controller**: Mid-stream interruption support

All this information is critical for maintaining experimental validity in this research platform.